<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="msapplication-config" content="none">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>世界最速だった URL ルーターをリリースしました | kuune.org</title>
<link rel="canonical" href="http://kuune.org/text/2014/06/12/denco/">

<link rel="stylesheet" href="http://kuune.org/css/normalize.css" media="all">
<link rel="stylesheet" href="http://kuune.org/css/common.css" media="all">

  <link rel="stylesheet" href="http://kuune.org/css/text.css" media="all">
</head>
<body>
  <div class="main">
    
      <article>
  <nav class="nav">
    
      <h4>Next article</h4>
      <p><a href="http://kuune.org/text/2014/06/17/commentary-of-denco">Denco 技術解説</a></p>
    
    
      <h4>Previous article</h4>
      <p><a href="http://kuune.org/text/2014/03/14/kocha-v0.3">Kocha が v0.3 になりました</a></p>
    
    <h4>Links</h4>
    <ul class="links">
      <li><a href="http://kuune.org/">kuune.org</a></li>
      <li><a href="https://twitter.com/naoina">Twitter</a></li>
      <li><a href="https://github.com/naoina">GitHub</a></li>
    </ul>
    <p><a href="http://kuune.org/text/index">Text index</a></p>
  </nav>
  <h1>世界最速だった URL ルーターをリリースしました</h1>
  <p>Created at: <time datetime="2014-06-12T18:35:08&#43;09:00">2014-06-12 18:35:08 &#43;0900</time></p>
  

<p>Golang 用 URL ルーター <a href="https://github.com/naoina/denco">Denco</a> をリリースしました。<br />
ちょっと前までは最速でしたが、<a href="https://github.com/julienschmidt/httprouter">HttpRouter</a> の作者によって高速にバックミラーから消し去られました。<br />
ですが、HttpRouter ではできないことが Denco にできたりしますしおすし。<br />
ベンチマークは <a href="https://github.com/julienschmidt/go-http-routing-benchmark">https://github.com/julienschmidt/go-http-routing-benchmark</a> からどうぞ。</p>

<h2 id="denco-とは:1d2dcdaa7033e85236908854dc845bef">Denco とは</h2>

<p>既に開発していた <a href="https://github.com/naoina/kocha-urlrouter">kocha-urlrouter</a> のダブル配列実装をベースに色々と手を加えたものになります。<br />
速度を重視して開発してましたが、前述の通り HttpRouter に追いぬかれました。</p>

<h2 id="使い方:1d2dcdaa7033e85236908854dc845bef">使い方</h2>

<p>下記のように使います。</p>

<pre><code class="language-go">router := denco.New()
router.Build([]denco.Record{
    {&quot;/&quot;, &quot;root&quot;},
    {&quot;/user/:id&quot;, 1024},
    {&quot;/user/:name/:id&quot;, []string{&quot;username&quot;}},
    {&quot;/static/*filepath&quot;, &quot;static&quot;},
})
data, params, found := router.Lookup(&quot;/&quot;)
fmt.Printf(&quot;%v\n&quot;, data.(string))
data, params, found = router.Lookup(&quot;/user/1&quot;)
fmt.Printf(&quot;%v, %v = %v\n&quot;, data.(int), params[0].Name, params[0].Value)
data, params, found = router.Lookup(&quot;/user/naoina/2&quot;)
fmt.Printf(&quot;%v\n&quot;, data.([]string))
for _, v := range params {
    fmt.Printf(&quot;%v = %v\n&quot;, v.Name, v.Value)
}
data, params, found = router.Lookup(&quot;/static/path/to/other&quot;)
fmt.Printf(&quot;%v, %v = %v\n&quot;, data, params[0].Name, params[0].Value)
</code></pre>

<p>README にも書いてあるんですが、Go の <a href="http://golang.org/pkg/net/http/#ServeMux">http.ServeMux</a> を置き換えるものではないので、<a href="http://golang.org/pkg/net/http/#Handler">http.Handler</a>  インターフェースは提供していません。<br />
ですので、HandlerFunc などを呼ぶためのグルーコードを書く必要があります。</p>

<pre><code class="language-go">package main

import (
    &quot;fmt&quot;
    &quot;log&quot;
    &quot;net/http&quot;

    &quot;github.com/naoina/denco&quot;
)

type handler struct {
    router *denco.Router
}

type handlerFunc func(http.ResponseWriter, *http.Request, []denco.Param)

func (h *handler) ServeHTTP(w http.ResponseWriter, r *http.Request) {
    m, params, found := h.router.Lookup(r.RequestURI)
    if !found {
        panic(&quot;route not found&quot;)
    }
    m.(handlerFunc)(w, r, params)
}

func Index(w http.ResponseWriter, r *http.Request, _ []denco.Param) {
    fmt.Fprint(w, &quot;Welcome!\n&quot;)
}

func Hello(w http.ResponseWriter, r *http.Request, params []denco.Param) {
    fmt.Fprintf(w, &quot;hello, %s!\n&quot;, params)
}

func main() {
    router := denco.New()
    if err := router.Build([]denco.Record{
        {&quot;/&quot;, handlerFunc(Index)},
        {&quot;/hello/naoina&quot;, handlerFunc(Hello)},
        {&quot;/hello/:name&quot;, handlerFunc(Hello)},
    }); err != nil {
        panic(err)
    }
    h := &amp;handler{router}
    log.Fatal(http.ListenAndServe(&quot;:8080&quot;, h))
}
</code></pre>

<p>これはそもそも <a href="https://github.com/naoina/kocha">Kocha</a> で使うために書き始めたものなので上記のようになっています。</p>

<h2 id="vs-httprouter:1d2dcdaa7033e85236908854dc845bef">vs HttpRouter</h2>

<p>再び最速の座を手に入れるべく頑張っていますが、現状では HttpRouter とほぼダブルスコアです。。。社会は厳しい！<br />
ですが、Denco にしかできないことがあります。<br />
例えば、HttpRouter では <code>/user/:name</code> と <code>/user/naoina</code> など、パラメーター付きパスと静的パスがかぶるようなルートが一緒に使えず、構築時に panic するようになっていますが、Denco だと問題ありません。</p>

<pre><code class="language-go">router.Build([]denco.Record{
    {&quot;/user/:name&quot;, &quot;first&quot;},
    {&quot;/user/naoina&quot;, &quot;second&quot;},
})
router.Lookup(&quot;/user/hoge&quot;) // &quot;first&quot;
router.Lookup(&quot;/user/foo&quot;) // &quot;first&quot;
router.Lookup(&quot;/user/naoina&quot;) // &quot;second&quot;
</code></pre>

<p>まぁ、負け惜しみです。</p>

<h2 id="まとめ:1d2dcdaa7033e85236908854dc845bef">まとめ</h2>

<p>私が調べた限りだと、ダブル配列を使った URL ルーターの実装というものがありませんでした。<br />
ですので、参考になるか分かりませんが、次回から Denco の技術解説みたいなのを書こうかなと考えています。</p>

</article>

    
  </div>
</body>
</html>
